
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Public Mods</title>
    <link rel="icon" type="image/png" href="image2.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: white;
            text-align: center;
        }

        header {
            padding: 10px 20px;
            background: #2c2c2c;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        h1 {
            margin: 0;
            font-size: 28px;
        }

        .search-box {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }

            .search-box input {
                padding: 5px;
                border: none;
                border-radius: 4px;
                font-size: 14px;
            }

        main {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .mods-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 600px;
        }

        .mod-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            width: 100%;
        }

            .mod-card h3 {
                margin: 0 0 5px;
                font-size: 18px;
            }

            .mod-card small {
                color: #bbb;
            }

        .download-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        .pagination {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

            .pagination button {
                background: #4CAF50;
                color: white;
                border: none;
                padding: 6px 10px;
                border-radius: 4px;
                cursor: pointer;
            }

                .pagination button:disabled {
                    background: #666;
                    cursor: not-allowed;
                }
    </style>
</head>
<body>

    <header>
        <h1>Public Mods</h1>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search mods...">
            <button id="searchBtn">Search</button>
        </div>
    </header>

    <main>
        <div class="mods-container" id="modsContainer"></div>
        <div class="pagination">
            <button id="prevPage">&lt; Prev</button>
            <span id="pageInfo">Page 1</span>
            <button id="nextPage">Next &gt;</button>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBpK_RPB-mr_EuaD594bEdS5DTqKPVzflg",
        authDomain: "minecraftaddoncreator.firebaseapp.com",
        projectId: "minecraftaddoncreator",
        storageBucket: "minecraftaddoncreator.appspot.com",
        messagingSenderId: "575674413085",
        appId: "1:575674413085:web:7b52ae5d59c418002816f4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const modsContainer = document.getElementById("modsContainer");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");

    let allMods = [];
    let filteredMods = [];
    let currentPage = 1;
    const modsPerPage = 4;

    async function fetchMods() {
        try { 
        allMods = [];
        const usersSnap = await getDocs(collection(db, "users"));

        for (const userDoc of usersSnap.docs) {
            const username = userDoc.id;
            const userData = userDoc.data();
            const isAdmin = !!userData.admin; // ✅ check if user is admin

            const modsSnap = await getDocs(collection(db, `users/${username}/MODS`));

            modsSnap.forEach(modDoc => {
                const data = modDoc.data();
                allMods.push({
                    name: data.name || "Unnamed Mod",
                    script: data.script || "",
                    owner: username,
                    ownerIsAdmin: isAdmin // ✅ store admin flag
                });
            });
        }

        filteredMods = [...allMods];
        renderPage();
        } catch (err) {
            console.log("Mods failed to load:", err);
            window.location.href = "DownError.html"; // ✅ only triggers if render fails
        }
    }

    function renderPage() {
        modsContainer.innerHTML = "";
        const start = (currentPage - 1) * modsPerPage;
        const end = start + modsPerPage;
        const modsToShow = filteredMods.slice(start, end);

        modsToShow.forEach(mod => {
            const card = document.createElement("div");
            card.className = "mod-card";

            // ✅ add badge if owner is admin
            const ownerDisplay = mod.ownerIsAdmin
                ? `${mod.owner} <img src="staff.png" alt="Admin" title="Admin" style="width:16px; height:16px; vertical-align:middle; margin-left:4px;">`
                : mod.owner;

            card.innerHTML = `
                <h3>${mod.name}</h3>
                <small>by ${ownerDisplay}</small>
                <p>${mod.script.slice(0, 60)}...</p>
                <button class="download-btn">Download BP</button>
            `;

            card.querySelector(".download-btn").onclick = () => {
                try {
                    const safe = (s) => s.replace(/[^\w-]+/g, "_").slice(0, 50) || "mod";
                    const zip = new JSZip();

                    const bpFolder = zip.folder(`${safe(mod.name)}_BP`);
                    const functionsFolder = bpFolder.folder("functions");

                    const manifest = {
                        format_version: 2,
                        header: {
                            name: mod.name,
                            description: "Generated mod from profile",
                            uuid: crypto.randomUUID(),
                            version: [1, 0, 0],
                            min_engine_version: [1, 19, 0]
                        },
                        modules: [
                            {
                                type: "data",
                                uuid: crypto.randomUUID(),
                                version: [1, 0, 0]
                            }
                        ]
                    };
                    bpFolder.file("manifest.json", JSON.stringify(manifest, null, 4));
                    functionsFolder.file("loop.mcfunction", mod.script || "");
                    functionsFolder.file("tick.json", JSON.stringify({ values: ["loop"] }, null, 4));

                    zip.generateAsync({ type: "blob" }).then(content => {
                        const a = document.createElement("a");
                        a.href = URL.createObjectURL(content);
                        a.download = `${safe(mod.name)}_BP.zip`;
                        a.click();
                        URL.revokeObjectURL(a.href);
                    });
                } catch (err) {
                    console.error("Failed to build BP zip:", err);
                    alert("Failed to create the pack. Check console for details.");
                }
            };

            modsContainer.appendChild(card);
        });

        pageInfo.textContent = `Page ${currentPage}`;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = end >= filteredMods.length;
    }

    searchBtn.addEventListener("click", () => {
        const term = searchInput.value.toLowerCase();
        filteredMods = allMods.filter(mod => mod.name.toLowerCase().includes(term));
        currentPage = 1;
        renderPage();
    });

    prevPageBtn.addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            renderPage();
        }
    });

    nextPageBtn.addEventListener("click", () => {
        if ((currentPage * modsPerPage) < filteredMods.length) {
            currentPage++;
            renderPage();
        }
    });

    fetchMods();
</script>


</body>
</html>

